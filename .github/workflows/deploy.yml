name: éƒ¨ç½²tgmeng-top-search-frontend

on:
  push:
    branches:
      - main  # è§¦å‘æ¡ä»¶ï¼Œæ ¹æ®ä½ çš„éœ€æ±‚é€‰æ‹©åˆ†æ”¯
    tags:
      - 'v*'  # è§¦å‘ Release åˆ›å»ºçš„æ ‡ç­¾æ¨¡å¼ï¼Œä¾‹å¦‚ v1.0.0ã€‚æ„æ€å°±æ˜¯å½“ä½ åˆ›å»ºä¸€ä¸ªä»¥vå¼€å¤´çš„tagæ—¶ï¼Œä¼šè‡ªåŠ¨å‘å¸ƒreleaseï¼Œè¿™éƒ¨åˆ†è‡ªåŠ¨å‘å¸ƒreleaseçš„é…ç½®åœ¨æœ€åé¢é‚£é‡Œï¼Œç¿»ä¸‹å»çœ‹

concurrency: # å¦‚æœå¤šä¸ªéƒ¨ç½²åŒæ—¶è§¦å‘ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨ä¸Šçš„ JAR æ–‡ä»¶å†²çªæˆ–è¦†ç›–ã€‚å»ºè®®ä½¿ç”¨ concurrency é™åˆ¶åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªéƒ¨ç½²è¿è¡Œ
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true


permissions:
  contents: write  # è¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†åœ¨æäº¤tagæ—¶ä»–è‡ªåŠ¨åˆ›å»ºreleaseå’Œä¸Šä¼ jaråŒ…éœ€è¦è¿™å„¿æƒé™
  packages: write  # æ·»åŠ å¯¹ packages çš„å†™å…¥æƒé™ï¼Œä»¥ä¾¿æ¨é€ GHCR é•œåƒï¼ˆgithub repository container registerï¼‰

jobs:
  deploy:
    runs-on: ubuntu-latest   # é€‰æ‹©è¿è¡Œç¯å¢ƒï¼Œubuntu-latest æ˜¯ Linux ç³»ç»Ÿ
    timeout-minutes: 30      # å•ä½ï¼šåˆ†é’Ÿ  å½“å‰çš„å·¥ä½œæµæ²¡æœ‰è®¾ç½®è¶…æ—¶æ—¶é—´ã€‚å¦‚æœæŸä¸ªæ­¥éª¤ï¼ˆå¦‚ Maven æ„å»ºæˆ– SSH å‘½ä»¤ï¼‰å¡ä½ï¼Œå¯èƒ½å¯¼è‡´å·¥ä½œæµé•¿æ—¶é—´æŒ‚èµ·
    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}          # DockerHub ç”¨æˆ·å
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}                # DockerHub è®¿é—®ä»¤ç‰Œ
      DOCKER_IMAGE_NAME: tgmeng-top-search-frontend                  # DockerHub é•œåƒåç§°ï¼ˆä¹Ÿå°±æ˜¯dockerHubé‡Œé¢çš„ä»“åº“çš„åå­—ï¼‰
      GHCR_IMAGE_NAME: tgmeng-top-search-frontend                    # GHCR é•œåƒåç§°ï¼ˆå»ºè®®æ˜¯ä»“åº“åï¼‰

    steps:
      # è·å–ä»£ç å¹¶æ„å»ºé¡¹ç›®
      - name: æ‹‰å–é¡¹ç›®ä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–å¹¶æ„å»º
        run: |
          npm ci
          npm run build

      - name: è·å–ç‰ˆæœ¬å·
        id: get_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "ç‰ˆæœ¬å·: $VERSION"
          echo "TAG_NAME=${VERSION}" >> $GITHUB_ENV
          echo "DOCKER_IMAGE_TAG=$VERSION" >> $GITHUB_ENV

      # ç™»å½• DockerHub
      - name: ç™»å½•Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_TOKEN }}
      # ç™»å½• GHCRï¼ˆgithub repository container registerï¼‰,ä¹Ÿå°±æ˜¯githubçš„dockeråº“
      - name: ç™»å½•GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      # æ„å»ºDockeré•œåƒï¼ˆDockerHubï¼‰
      - name: æ„å»ºDockeré•œåƒ
        run: |
          docker build \
           -t ${{ env.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_TAG }} \
           -t ${{ env.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest \
           -t ghcr.io/${{ github.repository_owner }}/${{ env.GHCR_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_TAG }} \
           -t ghcr.io/${{ github.repository_owner }}/${{ env.GHCR_IMAGE_NAME }}:latest \
           .
      # æ¨é€Dockeré•œåƒï¼ˆDockerHubï¼‰
      - name: æ¨é€Dockeré•œåƒ
        run: |
          echo "Pushing to ${{ env.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_TAG }}"
          docker push ${{ env.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_TAG }}
          echo "Pushing to ${{ env.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest"
          docker push ${{ env.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest

      # æ¨é€Dockeré•œåƒåˆ°GHCRï¼ˆgithub repository container registerï¼‰,ä¹Ÿå°±æ˜¯githubçš„dockeråº“
      # æ‹‰å–æ˜¯è¿™æ ·ï¼šdocker pull ghcr.io/YOUR_USERNAME/GHCR_IMAGE_NAME:tag
      - name: æ¨é€Dockeré•œåƒåˆ°GHCR
        run: |
          echo "Pushing to ghcr.io/${{ github.repository_owner }}/${{ env.GHCR_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_TAG }}"
          docker push ghcr.io/${{ github.repository_owner }}/${{ env.GHCR_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_TAG }}
          echo "Pushing to ghcr.io/${{ github.repository_owner }}/${{ env.GHCR_IMAGE_NAME }}:latest"
          docker push ghcr.io/${{ github.repository_owner }}/${{ env.GHCR_IMAGE_NAME }}:latest

      # åˆ›å»º GitHub Releaseï¼Œå½“åˆ›å»ºä»¥v*å¼€å¤´çš„tagæ—¶ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºreleaseï¼Œå°±æ˜¯å¼€å¤´å®šä¹‰çš„é‚£ä¸ªv*ï¼Œæ¯”å¦‚v1.0.1
      - name: åˆ›å»º GitHub Release
        id: create_release  # æ–°å¢ ID ä»¥ä¾›åç»­æ­¥éª¤å¼•ç”¨
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/create-release@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.TAG_NAME }}
          release_name: ${{ env.TAG_NAME }}
          body: |
            ğŸš€ Vue å‰ç«¯æ„å»ºå®Œæˆï¼
            - é•œåƒç‰ˆæœ¬: ${{ env.DOCKER_IMAGE_TAG }}
            - DockerHub: ${{ env.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}
            - GHCR: ghcr.io/${{ github.repository_owner }}/${{ env.GHCR_IMAGE_NAME }}
          draft: false
          prerelease: false